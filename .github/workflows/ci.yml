name: CI/CD Pipeline

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  test:
    name: Build and Test
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[ci skip]')"

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: 'recursive'

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          libelf1 libelf-dev zlib1g-dev libclang-dev \
          make git clang llvm pkg-config build-essential

    - name: Build BPF C programs
      run: |
        cd bpf
        make

    - name: Run C unit tests
      run: |
        cd bpf
        make test

    - name: Build frontend
      run: |
        cd frontend
        npm install
        npm run build

    - name: Build Rust collector
      run: |
        cd collector
        cargo build --verbose

    - name: Run Rust tests
      run: |
        cd collector
        cargo test --verbose

  docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: test
    # Only run on push to master, not on PRs
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/master' &&
      !contains(github.event.head_commit.message, '[skip ci]') &&
      !contains(github.event.head_commit.message, '[ci skip]')

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: 'recursive'

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          libelf1 libelf-dev zlib1g-dev libclang-dev \
          make git clang llvm pkg-config build-essential

    - name: Build package
      run: make build

    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to Github Packages
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build image and push to GitHub Container Registry
      uses: docker/build-push-action@v2
      with:
        context: ./
        file: dockerfile
        platforms: linux/amd64
        tags: |
          ghcr.io/${{ github.repository }}
        push: true

    - name: Image digest
      run: echo ${{ steps.docker_build.outputs.digest }}

  publish:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: test
    # Only run on push to master, not on PRs
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/master' &&
      !contains(github.event.head_commit.message, '[skip ci]') &&
      !contains(github.event.head_commit.message, '[ci skip]')

    strategy:
      matrix:
        target: [ x86_64-unknown-linux-gnu ]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: 'recursive'

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    - name: Set latest release version
      id: set_version
      uses: actions/github-script@v6
      with:
        result-encoding: string
        script: |
          const { data: releases } = await github.rest.repos.listReleases({
            owner: context.repo.owner,
            repo: context.repo.repo,
          });

          const { data: tags } = await github.rest.repos.listTags({
            owner: context.repo.owner,
            repo: context.repo.repo
          });

          if (releases.length === 0) { return "v0.0.1"; }

          function increase_v(version) {
            const parts = version.split(".");
            const last = parseInt(parts[2]) + 1;
            const next_version = `${parts[0]}.${parts[1]}.${last.toString()}`;
            return next_version;
          }

          const latest_release_tag = releases[0].tag_name;

          const tag = tags.find(tag => tag.commit.sha === context.sha);

          return tag ? tag.name : increase_v(latest_release_tag)

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          libelf1 libelf-dev zlib1g-dev libclang-dev \
          make git clang llvm pkg-config build-essential

    - name: Build package
      run: make build

    - name: Publish Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          collector/target/release/agentsight
        prerelease: false
        tag_name: ${{ steps.set_version.outputs.result }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
